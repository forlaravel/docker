server {
   ########################################
   ############ START IP CONFIG ###########
   ########################################
   # Define trusted IP ranges and configure real client IP extraction
   # Useful when NGINX is behind a proxy or load balancer

   set_real_ip_from 10.0.0.0/8;        # Trust Docker internal networks using the 10.x.x.x range
   set_real_ip_from 172.16.0.0/12;     # Trust Docker bridge networks (default 172.16.x.x to 172.31.x.x range)
   set_real_ip_from 192.168.0.0/16;    # Trust custom Docker networks using 192.168.x.x range
   set_real_ip_from 127.0.0.1;         # Trust localhost, useful for forwarded requests from the same container or host

   real_ip_header X-Forwarded-For; # Use X-Forwarded-For header to get the real client IP
   real_ip_recursive on; # Enable recursive search for real IP through proxies

   ########################################
   ############ END IP CONFIG #############
   ########################################

   ######### Nginx configuration #########
   listen 8000 default_server;
   listen [::]:8000 default_server;
   server_name localhost;
   server_tokens off;

   charset utf-8;
   client_max_body_size 2G;
   root /app/public;

   add_header X-Frame-Options "SAMEORIGIN";
   add_header X-Content-Type-Options "nosniff";
   add_header Referrer-Policy "strict-origin-when-cross-origin";
   add_header X-XSS-Protection "1; mode=block";
   add_header Permissions-Policy "camera=(), microphone=(), geolocation=(self)";

   index index.php;

   # Maintenance page for when backend is not ready (502/504 errors)
   error_page 502 504 /maintenance/maintenance.html;

   location = /maintenance/maintenance.html {
      root /etc/nginx;
      internal;
   }

   location /basic_status {
      stub_status;
      access_log off;
      allow 127.0.0.1;
      allow ::1;
      deny all;
   }

   location / {
      try_files $uri $uri/ /index.php?$query_string;
   }

   location = /favicon.ico { access_log off; log_not_found off; }
   location = /robots.txt  { access_log off; log_not_found off; }

   access_log /dev/stdout combined;
   error_log /dev/stderr warn;

   error_page 404 /index.php;

   include /etc/nginx/php-fpm-handler.conf;

   location ~ /\.(?!well-known).* {
      deny all;
   }
}

server {
   ########################################
   ############ START IP CONFIG ###########
   ########################################
   # Define trusted IP ranges and configure real client IP extraction
   # Useful when NGINX is behind a proxy or load balancer

   set_real_ip_from 10.0.0.0/8;        # Trust Docker internal networks using the 10.x.x.x range
   set_real_ip_from 172.16.0.0/12;     # Trust Docker bridge networks (default 172.16.x.x to 172.31.x.x range)
   set_real_ip_from 192.168.0.0/16;    # Trust custom Docker networks using 192.168.x.x range
   set_real_ip_from 127.0.0.1;         # Trust localhost, useful for forwarded requests from the same container or host

   real_ip_header X-Forwarded-For; # Use X-Forwarded-For header to get the real client IP
   real_ip_recursive on; # Enable recursive search for real IP through proxies

   ########################################
   ############ END IP CONFIG #############
   ########################################

   ######### Nginx configuration #########
   listen 8443 ssl default_server;
   listen [::]:8443 ssl default_server;
   server_name localhost;
   server_tokens off;

   ssl_certificate /etc/nginx/ssl/selfsigned.crt;
   ssl_certificate_key /etc/nginx/ssl/selfsigned.key;

   charset utf-8;
   client_max_body_size 2G;
   root /app/public;

   add_header X-Frame-Options "SAMEORIGIN";
   add_header X-Content-Type-Options "nosniff";
   add_header Referrer-Policy "strict-origin-when-cross-origin";
   add_header X-XSS-Protection "1; mode=block";
   add_header Permissions-Policy "camera=(), microphone=(), geolocation=(self)";

   index index.php;

   # Maintenance page for when backend is not ready (502/504 errors)
   error_page 502 504 /maintenance/maintenance.html;

   location = /maintenance/maintenance.html {
      root /etc/nginx;
      internal;
   }

   location /basic_status {
      stub_status;
      access_log off;
      allow 127.0.0.1;
      allow ::1;
      deny all;
   }

   location / {
      try_files $uri $uri/ /index.php?$query_string;
   }

   location = /favicon.ico { access_log off; log_not_found off; }
   location = /robots.txt  { access_log off; log_not_found off; }

   access_log /dev/stdout combined;
   error_log /dev/stderr warn;

   error_page 404 /index.php;

   include /etc/nginx/php-fpm-handler.conf;

   location ~ /\.(?!well-known).* {
      deny all;
   }
}
